name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build-wheels:
        name: Build wheels (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: linux-x86_64
                      os: ubuntu-latest
                      args: --release --out dist --features abi3
                      manylinux: auto
                      target: ""
                    - platform: linux-aarch64
                      os: ubuntu-latest
                      # Cross-compile using zig.
                      args: --release --out dist --features abi3 --zig
                      manylinux: auto
                      target: aarch64-unknown-linux-gnu
                    - platform: windows
                      os: windows-latest
                      args: --release --out dist --features abi3
                      manylinux: ""
                      target: ""
                    - platform: macos
                      os: macos-latest
                      # maturin v1 uses a synthetic target triple for universal2
                      args: --release --out dist --features abi3
                      manylinux: ""
                      target: universal2-apple-darwin

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup QEMU (for linux-aarch64)
              if: matrix.platform == 'linux-aarch64'
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: arm64

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  command: build
                  args: ${{ matrix.args }}
                  sccache: true
                  manylinux: ${{ matrix.manylinux }}
                  target: ${{ matrix.target }}

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-${{ matrix.platform }}
                  path: dist/*
                  if-no-files-found: error

    build-sdist:
        name: Build sdist
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist/*
                  if-no-files-found: error

    publish:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        needs:
            - build-wheels
            - build-sdist
        steps:
            - name: Download dists
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Publish
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  password: ${{ secrets.PYPI_API_TOKEN }}
                  skip-existing: true
